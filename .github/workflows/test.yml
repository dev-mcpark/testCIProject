name: test work flow

on: 
  push:
    branches:
      - feature/*
      - develope/*
      - hotfix/*
      - release/*

jobs:
  create_commit:
    runs-on: ubuntu-latest
    steps:
    - name: Create issue using REST API
      run: |
        curl --request POST \
        --url https://api.github.com/repos/${{ github.repository }}/issues \
        --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
        --header 'content-type: application/json' \
        --data '{
          "title": "Automated issue for commit: ${{ github.sha }}", 
          "body": "This issue was automatically created by the GitHub Action workflow **${{ github.workflow }}**. \n\n The commit hash was: _${{ github.sha }}_." 
          }'

  build:
    name: build
    runs-on: ubuntu-latest
    container: docker://python:3.6
    steps:
    - uses: actions/checkout@v1  # 코드 가져오기

    # - name: install package
    #   run: |
    #     apt-get -y update
    #     apt-get install default-libmysqlclient-dev python3-mysqldb \
    #                   default-mysql-client python-pip python3-dev build-essential
    #     ln -s /usr/lib/x86_64-linux-gnu/libmysqlclient.so /usr/lib/libmysqlclient.so.18
    #     curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
    #     apt-get install -y nodejs
    #     pip install --upgrade setuptools
    #     pip install awsebcli --upgrade
    #     pip install awscli --upgrade

    - name: install dependencies
      run: |
        python3 -m venv venv
        . venv/bin/activate
        pip install -r requirements.txt

  
  test:
    name: code test
    needs: build
    runs-on: ubuntu-latest
    container: docker://python:3.6
    steps:
    - uses: actions/checkout@v1
    - name: install dependencies
      run: |
        python3 -m venv venv
        . venv/bin/activate
        pip install -r requirements.txt

    - name: pytest
      env:
        DJANGO_SETTINGS_MODULE: ${{ secrets.TEST_DJANGO_SETTINGS_MODULE }}
      run: | 
        echo $DJANGO_SETTINGS_MODULE
        pytest

  deploy:
    name: deploy
    needs: [build, test]
    runs-on: ubuntu-latest
    steps:
      - name: My conditional step
        run: echo This event is a pull request that had an assignee removed.


    
