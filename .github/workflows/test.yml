name: test work flow

on: 
  push:
    branches:
      - feature/*
      - develope/*
      - hotfix/*
      - release/*

jobs:
  slack_message:
    runs-on: ubuntu-latest
    steps:
    - name: Create slack message using incoming hook
      run: |
        curl --request POST \
        --url https://hooks.slack.com/services/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 \
        --header 'content-type: application/json' \
        --data '{
          "channel": "#git_timespread",
          "username": "github action",
          "text": "github action work flow 중 slack incoming hook 메세지 보내기",
          "icon_emoji": ":ghost:"
          }'

  build:
    name: build
    runs-on: ubuntu-latest
    container: docker://python:3.6
    steps:
    - uses: docker://python:3.6
    - uses: actions/checkout@v1

    # - name: install package
    #   run: |
    #     apt-get -y update
    #     apt-get install default-libmysqlclient-dev python3-mysqldb \
    #                   default-mysql-client python-pip python3-dev build-essential
    #     ln -s /usr/lib/x86_64-linux-gnu/libmysqlclient.so /usr/lib/libmysqlclient.so.18
    #     curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
    #     apt-get install -y nodejs
    #     pip install --upgrade setuptools
    #     pip install awsebcli --upgrade
    #     pip install awscli --upgrade

    - name: install dependencies
      run: |
        python3 -m venv venv
        . venv/bin/activate
        pip install -r requirements.txt

  
  test:
    name: code test
    needs: build
    runs-on: ubuntu-latest
    container: docker://python:3.6
    steps:
    
    - name: install dependencies
      run: |
        python3 -m venv venv
        . venv/bin/activate
        pip install -r requirements.txt

    - name: pytest
      env:
        DJANGO_SETTINGS_MODULE: ${{ secrets.TEST_DJANGO_SETTINGS_MODULE }}
      run: | 
        echo $DJANGO_SETTINGS_MODULE
        pytest

  deploy:
    name: deploy
    needs: [build, test]
    runs-on: ubuntu-latest
    steps:
      - name: My conditional step
        run: echo This event is a pull request that had an assignee removed.


    
